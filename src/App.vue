<template>
  <div class="flex h-screen bg-gray-50 text-gray-800">
    <!-- 左侧边栏 - 对话历史 -->
    <div class="w-80 bg-gray-100 border-r border-gray-200 flex flex-col">
      <!-- 头部区域 -->
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center gap-3 mb-6">
          <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center">
            <span class="text-white font-bold text-sm">HEC</span>
          </div>
          <h1 class="text-lg font-bold text-gray-800">药剂综合大模型</h1>
        </div>
        
        <!-- 新对话按钮 -->
        <div class="flex gap-2">
          <button 
            class="flex-1 px-4 py-2.5 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-all flex items-center justify-center gap-2"
            @click="startNewChat"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            新对话
          </button>
          <button 
            class="px-3 py-2.5 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-all"
            @click="exportChat"
            title="导出对话"
          >
            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </button>
        </div>
      </div>
      
      <!-- 聊天历史列表 -->
      <div class="flex-1 overflow-y-auto p-3 space-y-2">
        <div 
          v-for="(chat, index) in chatHistory" 
          :key="index"
          class="p-3 rounded-lg text-sm cursor-pointer transition-all relative group"
          :class="currentChatIndex === index 
            ? 'bg-blue-50 border border-blue-200' 
            : 'bg-white border border-gray-200 hover:bg-gray-50 hover:border-gray-300'"
          @click="loadChat(index)"
        >
          <div class="flex items-start gap-3">
            <div class="w-5 h-5 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0 mt-0.5">
              <svg class="w-3 h-3 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path>
              </svg>
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-gray-800 truncate">{{ chat.question }}</p>
              <p class="text-xs text-gray-500 mt-1">{{ formatDate(chat.timestamp) }}</p>
            </div>
            <button 
              class="opacity-0 group-hover:opacity-100 w-5 h-5 rounded-full hover:bg-red-100 flex items-center justify-center transition-all"
              @click.stop="deleteChat(index)"
              title="删除对话"
            >
              <svg class="w-3 h-3 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>
        
        <!-- 加载更多 -->
        <div v-if="chatHistory.length > 5" class="text-center py-4">
          <button 
            class="text-sm text-blue-600 hover:text-blue-700 transition-colors"
            @click="loadMoreChats"
          >
            点击加载更多
          </button>
        </div>
      </div>
    </div>

    <!-- 主聊天区域 -->
    <div class="flex-1 flex flex-col bg-white">
      <!-- 主区域头部 -->
      <div class="p-4 border-b border-gray-200 bg-white">
        <div class="flex justify-between items-center">
          <div class="flex items-center gap-3">
            <h2 class="text-lg font-semibold text-gray-800">
              {{ currentChatTitle || '新对话' }}
            </h2>
            <div class="flex items-center gap-2">
              <div class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center">
                <span class="text-xs font-medium text-blue-600">①</span>
              </div>
              <span class="text-sm text-gray-500">{{ currentChat.messages.length }}条记录</span>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <button 
              class="p-2 hover:bg-gray-100 rounded-lg transition-colors"
              title="更多选项"
            >
              <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path>
              </svg>
            </button>
          </div>
        </div>
        
        <!-- 语言选择卡片 -->
        <div class="mt-4 p-3 bg-gray-50 rounded-lg">
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-600">*语言/Language</span>
            <select 
              v-model="language" 
              @change="changeLanguage"
              class="ml-auto px-3 py-1.5 border border-gray-300 rounded-md bg-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50"
            >
              <option value="zh">中文</option>
              <option value="en">English</option>
            </select>
            
          </div>
        </div>
      </div>

      <div class="flex-1 overflow-y-auto p-4 space-y-3" ref="chatMessagesContainer">
        <!-- 欢迎消息 -->
        <div class="flex gap-3" v-if="currentChat.messages.length === 0">
          <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center flex-shrink-0">
            <span class="text-white font-bold text-sm">HEC</span>
          </div>
          <div class="flex-1">
            <div class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm">
              <div class="flex items-center gap-2 mb-3">
                <span class="text-xs text-gray-500">{{ formatTime(new Date()) }}</span>
              </div>
              <p class="leading-relaxed text-gray-800 mb-4">
                {{ language === 'zh' 
                  ? '您好,我是基于集团本地部署 DeepSeek-R1 的药物制剂垂直大模型。此应用适用于药剂学通用知识与前沿研究问答。以下提问模板供参考:' 
                  : 'Hello, I am a pharmaceutical formulation vertical large model based on the group\'s local deployment of DeepSeek-R1. This application is suitable for general knowledge and cutting-edge research questions in pharmaceutics. The following question templates are provided for reference:' 
                }}
              </p>
              
              <!-- 示例问题 -->
              <div class="space-y-3">
                <div>
                  <h4 class="text-sm font-semibold mb-2 text-gray-800">{{ language === 'zh' ? '单轮对话:' : 'Single-turn dialogue:' }}</h4>
                  <ul class="space-y-1.5">
                    <li v-for="(q, idx) in exampleQuestions.singleTurn[language]" :key="idx" 
                        class="bg-gray-50 rounded-lg text-sm text-gray-700 cursor-pointer border border-gray-200 hover:bg-gray-100 hover:border-gray-300 transition-all" 
                        @click="sendExampleQuestion(q)">
                      {{ q }}
                    </li>
                  </ul>
                </div>
                <div>
                  <h4 class="text-sm font-semibold mb-2 text-gray-800">{{ language === 'zh' ? '多轮对话:' : 'Multi-turn dialogue:' }}</h4>
                  <div class="space-y-2.5">
                    <div v-for="(section, sectionIdx) in exampleQuestions.multiTurn[language]" :key="sectionIdx">
                      <div class="text-xs font-medium text-gray-600 mb-1.5">{{ sectionIdx + 1 }}. {{ section.title }}</div>
                      <ul class="space-y-1.5">
                        <li v-for="(q, idx) in section.questions" :key="idx" 
                            class="p-3 bg-gray-50 rounded-lg text-sm text-gray-700 cursor-pointer border border-gray-200 hover:bg-gray-100 hover:border-gray-300 transition-all" 
                            @click="sendExampleQuestion(q)">
                          {{ q }}
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 用户和助手的消息 -->
        <template v-for="(message, index) in currentChat.messages" :key="index">
          <div 
            class="flex gap-4" 
            :class="message.role === 'user' ? 'justify-end' : ''"
          >
            <template v-if="message.role === 'assistant'">
              <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center flex-shrink-0">
                <span class="text-white font-bold text-sm">HEC</span>
              </div>
            </template>
            
            <div 
              class="max-w-[80%]"
              :class="message.role === 'user' ? 'order-1' : 'order-2 flex-1'"
            >
              <template v-if="loading && index === currentChat.messages.length - 1">
                <!-- 加载状态 - 思考动画 -->
                <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm message-appear">
                  <div class="thinking-container">
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                    <span class="text-sm text-gray-500 ml-2">{{ language === 'zh' ? '正在思考中...' : 'Thinking...' }}</span>
                  </div>
                </div>
              </template>
              <template v-else>
                <div 
                  class="p-3 rounded-xl border shadow-sm group relative"
                  :class="message.role === 'user' 
                    ? 'bg-blue-600 text-white border-blue-600' 
                    : 'bg-white border-gray-200'"
                >
                  
                  <!-- 思考过程显示 -->
                  <div v-if="showThinking && thinkingContent" class="mb-3">
                    <div class="bg-gray-50 border border-gray-200 rounded-lg overflow-hidden">
                      <button 
                        @click="showThinking = !showThinking"
                        class="w-full px-3 py-2 bg-gray-100 hover:bg-gray-200 transition-colors flex items-center justify-between text-left"
                      >
                        <div class="flex items-center gap-2">
                          <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                          </svg>
                          <span class="text-sm font-medium text-gray-700">思考过程</span>
                          <span class="text-xs text-gray-500">({{ thinkingContent.length }} 字符)</span>
                        </div>
                        <svg 
                          class="w-4 h-4 text-gray-600 transition-transform"
                          :class="showThinking ? 'rotate-180' : ''"
                          fill="none" 
                          stroke="currentColor" 
                          viewBox="0 0 24 24"
                        >
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                      </button>
                      <div v-if="showThinking" class="p-3 bg-white">
                        <div class="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed font-mono">
                          {{ thinkingContent }}
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <p v-html="formatMessage(message.content)" class="whitespace-pre-wrap leading-relaxed"></p>
                  <!-- 引用部分 -->
                  <div v-if="message.references && message.references.length > 0" class="mt-3">
                    <h4 class="text-sm font-semibold mb-1.5 text-gray-600 flex items-center gap-1.5" :class="message.role === 'user' ? 'text-white/80' : ''">
                      <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded">📚</span>
                      {{ language === 'zh' ? '参考文献' : 'References' }}
                    </h4>
                    <div class="space-y-1">
                      <div v-for="(ref, refIdx) in message.references" :key="refIdx" class="reference-item">
                        <span class="reference-icon">{{ refIdx + 1 }}.</span>
                        <span class="reference-content" v-html="formatMessage(ref)"></span>
                      </div>
                    </div>
                  </div>
                  <!-- 消息时间戳和操作按钮 -->
                  <div class="flex items-center justify-between mt-1.5">
                    <div class="text-[11px] text-gray-400" :class="message.role === 'user' ? 'text-white/60' : ''">
                      {{ formatTime(message.timestamp || new Date()) }}
                    </div>
                    <!-- 右下角操作按钮 -->
                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                      <button 
                        class="p-1 rounded transition-colors"
                        :class="message.role === 'user' ? 'hover:bg-blue-500' : 'hover:bg-gray-100'"
                        @click="copyMessage(message.content)"
                        title="复制"
                      >
                        <svg class="w-3 h-3 transition-colors" 
                             :class="message.role === 'user' ? 'text-white/80 hover:text-white' : 'text-gray-500'" 
                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                      </button>
                      <button 
                        v-if="message.role === 'assistant'"
                        class="p-1 hover:bg-gray-100 rounded transition-colors"
                        @click="likeMessage(index)"
                        title="点赞"
                      >
                        <svg class="w-3 h-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                        </svg>
                      </button>
                      <button 
                        class="p-1 rounded transition-colors"
                        :class="message.role === 'user' ? 'hover:bg-blue-500' : 'hover:bg-gray-100'"
                        @click="deleteMessage(index)"
                        title="删除消息"
                      >
                        <svg class="w-3 h-3 transition-colors" 
                             :class="message.role === 'user' ? 'text-white/80 hover:text-white' : 'text-gray-500'" 
                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              </template>
            </div>
            
            <template v-if="message.role === 'user'">
              <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-sm text-gray-600 order-0 flex-shrink-0">👤</div>
            </template>
          </div>
        </template>
      </div>

      <!-- 输入区域 -->
      <div class="p-3 border-t border-gray-200 bg-white">
        <div class="flex gap-3">
          <!-- 左侧操作按钮 -->
          <div class="flex gap-2">
            <button 
              class="p-2 hover:bg-gray-100 rounded-lg transition-colors"
              @click="copyInput"
              title="复制"
            >
              <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
            </button>
            <button 
              class="p-2 hover:bg-gray-100 rounded-lg transition-colors"
              @click="regenerateResponse"
              title="重新生成"
            >
              <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
            </button>
            <button 
              class="p-2 hover:bg-gray-100 rounded-lg transition-colors"
              @click="clearInput"
              title="清空"
            >
              <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
          
          <!-- 输入框 -->
          <div class="flex-1 relative">
            <textarea 
              v-model="userInput" 
              @keydown.ctrl.enter="sendMessage"
              @keydown.shift.enter="sendMessage"
              @keydown.escape="clearInput"
              :placeholder="language === 'zh' ? '请输入您的问题...' : 'Please enter your question...'"
              :disabled="loading"
              class="w-full p-3 pr-12 border border-gray-300 rounded-lg text-sm leading-relaxed resize-none min-h-[44px] max-h-[120px] focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors disabled:bg-gray-50 disabled:cursor-not-allowed"
            ></textarea>
          </div>
          
          <!-- 发送按钮 -->
          <button 
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center gap-2"
            @click="sendMessage"
            :disabled="loading || !userInput.trim()"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
            {{ language === 'zh' ? '发送' : 'Send' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { ref, reactive, onMounted, nextTick } from 'vue';
import { EventSourcePolyfill } from 'event-source-polyfill';

export default {
  name: 'App',
  setup() {
    // 状态管理
    const language = ref('zh');
    const userInput = ref('');
    const loading = ref(false);
    const chatHistory = ref([]);
    const currentChat = reactive({
      messages: []
    });
    const chatMessagesContainer = ref(null);
    const currentChatIndex = ref(-1);
    const currentChatTitle = ref('');
    const isInThinkingMode = ref(false);
    const thinkingContent = ref('');
    const showThinking = ref(false);

    // 初始化加载历史聊天记录
    onMounted(() => {
      loadChatHistory();
    });

    // 加载聊天历史
    const loadChatHistory = () => {
      const savedHistory = localStorage.getItem('chatHistory');
      if (savedHistory) {
        chatHistory.value = JSON.parse(savedHistory);
      }
    };

    // 保存聊天历史
    const saveChatHistory = () => {
      // 处理ref对象，确保正确序列化
      const historyToSave = chatHistory.value.map(chat => ({
        question: chat.question,
        timestamp: chat.timestamp || new Date(),
        messages: chat.messages.map(msg => ({
          role: msg.role,
          content: msg.content,
          references: msg.references || [],
          timestamp: msg.timestamp || new Date()
        }))
      }));
      localStorage.setItem('chatHistory', JSON.stringify(historyToSave));
    };

    // 开始新对话
    const startNewChat = () => {
      currentChat.messages = [];
      userInput.value = '';
      currentChatIndex.value = -1;
      currentChatTitle.value = '';
      isInThinkingMode.value = false;
      thinkingContent.value = '';
      showThinking.value = false;
    };

    // 加载历史对话
    const loadChat = (index) => {
      const chat = chatHistory.value[index];
      const messages = chat.messages;
      currentChat.messages = messages.map(msg => ({
        ...msg
      }));
      currentChatIndex.value = index;
      currentChatTitle.value = chat.question;
    };

    // 删除聊天记录
    const deleteChat = (index) => {
      if (confirm(language.value === 'zh' ? '确定要删除这条对话记录吗？' : 'Are you sure you want to delete this conversation?')) {
        chatHistory.value.splice(index, 1);
        saveChatHistory();
      }
    };

    // 示例问题
    const exampleQuestions = {
      singleTurn: {
        zh: [
          '影响半固体剂型溶出特征的关键因素有哪些？',
          '气体分散型剂型的优势是什么？'
        ],
        en: [
          'What are the key factors affecting the dissolution characteristics of semi-solid dosage forms?',
          'What are the advantages of gas dispersion dosage forms?'
        ]
      },
      multiTurn: {
        zh: [
          {
            title: '固体分散体技术综述',
            questions: [
              '制备固体分散体剂型的主要目的是什么？',
              '采用固体分散体技术可使药物的溶出速率提升多少？',
              '固体分散体中溶解增强的可能机制有哪些？'
            ]
          },
          {
            title: '纳米颗粒案例研究',
            questions: [
              '纳米颗粒在药物递送中的优势是什么？',
              '如何制备稳定的纳米颗粒制剂？'
            ]
          }
        ],
        en: [
          {
            title: 'Review of Solid Dispersion Technology',
            questions: [
              'What is the primary purpose of creating solid dispersion dosage forms?',
              'How much can the dissolution rate of a drug increase when using solid dispersions?',
              'What are the possible mechanisms of enhanced dissolution in solid dispersions?'
            ]
          },
          {
            title: 'Nanoparticle Case Study',
            questions: [
              'What are the advantages of nanoparticles in drug delivery?',
              'How to prepare stable nanoparticle formulations?'
            ]
          }
        ]
      }
    };

    // 切换语言
    const changeLanguage = () => {
      // 语言切换时可能需要的操作
    };

    // 发送示例问题
    const sendExampleQuestion = (question) => {
      userInput.value = question;
      sendMessage();
    };

    // 发送消息
    const sendMessage = async () => {
      if (!userInput.value.trim() || loading.value) return;

      const question = userInput.value.trim();
      
      // 添加用户消息到当前对话
      currentChat.messages.push({
        role: 'user',
        content: question,
        timestamp: new Date()
      });

      // 滚动到底部
      nextTick(() => {
        scrollToBottom();
      });

      // 清空输入框
      userInput.value = '';
      
      // 设置加载状态
      loading.value = true;
      isInThinkingMode.value = false;
      thinkingContent.value = '';
      showThinking.value = false;

      try {
        // 准备API请求参数
        // 使用相对路径，利用Vite的代理配置处理跨域和重定向
        const apiUrl = '/api/v1/chat/completions';
        const apiKey = 'fastgpt-mKIZmHlk5l9WSEuyMlqfqpEXEb4OzTc0nd5zFJp3DAWX0zxbGddjySq3eC';
        
        // 构建消息历史
        let messages = [];
        
        // 添加开场白（根据客户要求文档）
        messages.push({ role: 'user', content: '这是一个模拟开场白' });
        messages.push({ role: 'assistant', content: '\n我是一位制剂专家。' });
        
        // 添加用户问题
        messages.push({ role: 'user', content: question });

        // 创建响应元素 - 直接使用字符串，避免ref包装
        const responseElement = {
          role: 'assistant',
          content: '',
          references: [],
          timestamp: new Date()
        };
        
        currentChat.messages.push(responseElement);

        // 设置请求超时 - 延长到5分钟（300秒）以适应慢速响应
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 300000); // 300秒超时

        try {
          // 使用fetch API处理SSE流式响应
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`,
            'Accept': 'text/event-stream',
            'Cache-Control': 'no-cache',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({
            stream: true,
            messages: messages,
            model: 'DeepSeek-R1'
          }),
          // 使用credentials: 'include'来确保在重定向过程中也发送凭证
          credentials: 'include',
          mode: 'cors',
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          const errorText = await response.text();
          console.error(`HTTP错误! 状态码: ${response.status}, 错误信息: ${errorText}`);
          console.error('请求URL:', apiUrl);
          console.error('请求头:', {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`,
            'Accept': 'text/event-stream',
            'Cache-Control': 'no-cache',
            'X-Requested-With': 'XMLHttpRequest'
          });
          console.error('请求体:', JSON.stringify({
            stream: true,
            messages: messages,
            model: 'DeepSeek-R1'
          }, null, 2));
          throw new Error(`HTTP错误! 状态码: ${response.status}, 错误信息: ${errorText}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let done = false;

        while (!done) {
          const { value, done: readerDone } = await reader.read();
          done = readerDone;
          
          if (value) {
            const chunk = decoder.decode(value, { stream: true });
            console.log('接收到的原始SSE数据块:', chunk);
            // 处理SSE数据格式
            const lines = chunk.split('\n');
            console.log('分割后的行数:', lines.length);
            
            for (const line of lines) {
              console.log('处理行:', line);
              if (line.startsWith('data: ')) {
                const data = line.slice(6);
                console.log('提取的数据内容:', data);
                
                if (data === '[DONE]') {
                  // 保存到历史记录
                  if (chatHistory.value.length >= 10) {
                    chatHistory.value.shift();
                  }
                  chatHistory.value.push({
                    question: question,
                    messages: [...currentChat.messages],
                    timestamp: new Date()
                  });
                  saveChatHistory();
                  // 响应完成时设置loading为false
                  loading.value = false;
                  break;
                }
                
                try {
                  const parsed = JSON.parse(data);
                  
                  // 检查不同的响应格式
                  let content = null;
                  console.log('完整的parsed响应:', JSON.stringify(parsed, null, 2));
                  
                  // 首先检查是否有任何内容，如果有就停止loading
                  const hasContent = parsed.choices && parsed.choices[0] && parsed.choices[0].delta && parsed.choices[0].delta.content;
                  const hasReasoningContent = parsed.choices && parsed.choices[0] && parsed.choices[0].delta && parsed.choices[0].delta.reasoning_content;
                  
                  if ((hasContent || hasReasoningContent) && loading.value) {
                    console.log('检测到响应内容，停止loading状态');
                    loading.value = false;
                  }
                  
                  // 如果只有reasoning_content而没有content，说明这是答案内容，不是思考过程
                  if (hasReasoningContent && !hasContent) {
                    console.log('检测到只有reasoning_content，将其作为答案内容显示');
                    isInThinkingMode.value = false; // 强制退出思考模式
                  }
                  
                  // 格式1: choices[0].delta.content (标准OpenAI格式) - 优先显示最终答案
                  if (hasContent) {
                    content = parsed.choices[0].delta.content;
                    console.log('使用格式1 - choices[0].delta.content:', content);
                  }
                  // 格式2: choices[0].delta.reasoning_content (DeepSeek-R1内容) - 仅在没有content时显示
                  else if (hasReasoningContent) {
                    const reasoningContent = parsed.choices[0].delta.reasoning_content;
                    
                    // 检查是否是思考过程的开始标记
                    if (reasoningContent === '<think>') {
                      isInThinkingMode.value = true;
                      thinkingContent.value = '';
                      showThinking.value = true;
                      console.log('开始思考过程');
                      continue; // 跳过思考开始标记
                    }
                    
                    // 检查是否是思考过程的结束标记
                    if (reasoningContent === '</think>') {
                      isInThinkingMode.value = false;
                      console.log('结束思考过程');
                      continue; // 跳过思考结束标记
                    }
                    
                    // 如果在思考模式中，收集思考内容
                    if (isInThinkingMode.value) {
                      thinkingContent.value += reasoningContent;
                      console.log('收集思考过程内容:', reasoningContent);
                      // 强制Vue重新渲染思考内容
                      nextTick(() => {
                        scrollToBottom();
                      });
                      continue;
                    }
                    
                    // 只有在非思考模式下才显示内容
                    content = reasoningContent;
                    console.log('使用格式2 - choices[0].delta.reasoning_content:', content);
                  }
                  // 格式3: choices[0].text (替代格式)
                  else if (parsed.choices && parsed.choices[0] && parsed.choices[0].text) {
                    content = parsed.choices[0].text;
                    console.log('使用格式3 - choices[0].text:', content);
                  }
                  // 格式4: content字段直接返回
                  else if (parsed.content) {
                    content = parsed.content;
                    console.log('使用格式4 - content字段:', content);
                  }
                  // 格式5: data字段
                  else if (parsed.data) {
                    content = parsed.data;
                    console.log('使用格式5 - data字段:', content);
                  }
                  
                  if (content) {
                    responseElement.content += content;
                    // 强制Vue重新渲染
                    currentChat.messages = [...currentChat.messages];
                    // 每次更新内容后滚动到底部
                    nextTick(() => {
                      scrollToBottom();
                    });
                  } else {
                    console.log('未找到有效的内容字段，响应结构:', parsed);
                  }
                  
                  // 处理可能的参考文献
                  if (parsed.choices && parsed.choices[0] && parsed.choices[0].delta && parsed.choices[0].delta.references) {
                    responseElement.references = parsed.choices[0].delta.references;
                  }
                } catch (e) {
                  console.error('解析响应失败:', e, '响应内容:', data);
                }
              }
            }
          }
        }
        } catch (error) {
        clearTimeout(timeoutId);
        // 处理不同类型的错误
        if (error.name === 'AbortError') {
          console.error('请求超时: API响应时间超过300秒');
          throw new Error('请求超时，请检查网络连接或稍后再试');
        } else if (error.message.includes('Failed to fetch')) {
          console.error('网络请求失败:', error);
          throw new Error('网络连接失败，请检查您的网络设置或稍后再试');
        } else {
          throw error;
        }
      }
      } catch (error) {
        console.error('发送消息失败:', error);
        loading.value = false;
        
        // 添加更详细的错误消息
        const errorMessage = {
          role: 'assistant',
          content: language.value === 'zh' 
            ? `抱歉，我暂时无法为您提供答案。错误信息：${error.message}。请稍后再试。` 
            : `Sorry, I cannot provide an answer for you at the moment. Error: ${error.message}. Please try again later.`,
          references: [],
          timestamp: new Date()
        };
        currentChat.messages.push(errorMessage);
        // 只有在错误情况下才设置loading为false
        loading.value = false;
      } finally {
        // 移除finally中的无条件设置loading为false
        // 确保只有在请求完成或出错时才设置loading为false
      }
    };

    // 格式化消息内容（支持简单的Markdown）
    const formatMessage = (content) => {
      console.log('formatMessage接收到的内容:', content);
      if (!content || content.trim() === '') {
        console.log('内容为空，返回空字符串');
        return '';
      }
      
      // 简单的Markdown解析
      let formatted = content
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code>$1</code>');
      
      console.log('格式化后的内容:', formatted);
      return formatted;
    };

    // 滚动到底部
    const scrollToBottom = () => {
      if (chatMessagesContainer.value) {
        chatMessagesContainer.value.scrollTop = chatMessagesContainer.value.scrollHeight;
      }
    };

    // 清空输入框
    const clearInput = () => {
      userInput.value = '';
    };

    // 格式化时间
    const formatTime = (date) => {
      const now = new Date(date);
      return now.toLocaleTimeString('zh-CN', {
        hour: '2-digit',
        minute: '2-digit'
      });
    };

    // 格式化日期
    const formatDate = (date) => {
      const now = new Date(date);
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      return `${month}-${day}`;
    };

    // 复制消息
    const copyMessage = async (content) => {
      try {
        await navigator.clipboard.writeText(content);
        // 可以添加提示
      } catch (err) {
        console.error('复制失败:', err);
      }
    };

    // 复制输入内容
    const copyInput = async () => {
      try {
        await navigator.clipboard.writeText(userInput.value);
      } catch (err) {
        console.error('复制失败:', err);
      }
    };

    // 重新生成响应
    const regenerateResponse = () => {
      if (currentChat.messages.length > 0) {
        const lastUserMessage = currentChat.messages.filter(msg => msg.role === 'user').pop();
        if (lastUserMessage) {
          userInput.value = lastUserMessage.content;
          sendMessage();
        }
      }
    };

    // 点赞消息
    const likeMessage = (index) => {
      // 实现点赞功能
      console.log('点赞消息:', index);
    };

    // 删除消息
    const deleteMessage = (index) => {
      if (confirm('确定要删除这条消息吗？')) {
        currentChat.messages.splice(index, 1);
        // 保存更新后的聊天记录
        saveChatHistory();
        console.log('删除消息:', index);
      }
    };

    // 导出对话
    const exportChat = () => {
      if (currentChat.messages.length === 0) {
        alert('没有对话内容可导出');
        return;
      }
      
      const chatData = {
        title: currentChatTitle.value || '对话记录',
        messages: currentChat.messages.map(msg => ({
          role: msg.role,
          content: msg.content,
          timestamp: msg.timestamp
        })),
        exportTime: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(chatData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `chat-${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };

    // 加载更多聊天记录
    const loadMoreChats = () => {
      // 实现加载更多功能
      console.log('加载更多聊天记录');
    };

    return {
      language,
      userInput,
      loading,
      chatHistory,
      currentChat,
      currentChatIndex,
      currentChatTitle,
      isInThinkingMode,
      thinkingContent,
      showThinking,
      exampleQuestions,
      startNewChat,
      loadChat,
      changeLanguage,
      sendExampleQuestion,
      sendMessage,
      formatMessage,
      chatMessagesContainer,
      clearInput,
      deleteChat,
      formatTime,
      formatDate,
      copyMessage,
      copyInput,
      regenerateResponse,
      likeMessage,
      deleteMessage,
      exportChat,
      loadMoreChats
    };
  }
};
</script>
