<template>
  <div class="flex h-screen bg-gray-50 text-gray-800">
    <!-- 左侧边栏 - 对话历史 -->
    <div class="w-80 bg-gray-100 border-r border-gray-200 flex flex-col">
      <!-- 头部区域 -->
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center gap-3 mb-6">
          <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center">
            <span class="text-white font-bold text-sm">HEC</span>
          </div>
          <h1 class="text-lg font-bold text-gray-800">药剂综合大模型</h1>
        </div>
        <!-- 新对话按钮 -->
        <div class="flex gap-2">
          <button 
            class="flex-1 px-4 py-2.5 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-all flex items-center justify-center gap-2"
            @click="startNewChat"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            新对话
          </button>
          <button 
            class="px-3 py-2.5 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-all"
            @click="exportChat"
            title="导出对话"
          >
            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </button>
        </div>
      </div>
      <!-- 聊天历史列表 -->
      <div class="flex-1 overflow-y-auto p-3 space-y-2">
        <div 
          v-for="(chat, index) in chatHistory" 
          :key="index"
          class="p-3 rounded-lg text-sm cursor-pointer transition-all relative group"
          :class="currentChatIndex === index 
            ? 'bg-blue-50 border border-blue-200' 
            : 'bg-white border border-gray-200 hover:bg-gray-50 hover:border-gray-300'"
          @click="loadChat(index)"
        >
          <div class="flex items-start gap-3">
            <div class="w-5 h-5 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0 mt-0.5">
              <svg class="w-3 h-3 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path>
              </svg>
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-gray-800 truncate">{{ chat.question }}</p>
              <p class="text-xs text-gray-500 mt-1">{{ formatDate(chat.timestamp) }}</p>
            </div>
            <button 
              class="opacity-0 group-hover:opacity-100 w-5 h-5 rounded-full hover:bg-red-100 flex items-center justify-center transition-all"
              @click.stop="deleteChat(index)"
              title="删除对话"
            >
              <svg class="w-3 h-3 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>
        <!-- 加载更多 -->
        <div v-if="chatHistory.length > 5" class="text-center py-4">
          <button 
            class="text-sm text-blue-600 hover:text-blue-700 transition-colors"
            @click="loadMoreChats"
          >
            点击加载更多
          </button>
        </div>
      </div>
    </div>

    <!-- 主聊天区域 -->
    <div class="flex-1 flex flex-col bg-white">
      <!-- 主区域头部 -->
      <div class="p-4 border-b border-gray-200 bg-white">
        <div class="flex justify-between items-center">
          <div class="flex items-center gap-3">
            <h2 class="text-lg font-semibold text-gray-800">
              {{ currentChatTitle || '新对话' }}
            </h2>
            <div class="flex items-center gap-2">
              <div class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center">
                <span class="text-xs font-medium text-blue-600">①</span>
              </div>
              <span class="text-sm text-gray-500">{{ currentChat.messages.length }}条记录</span>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <!-- 用户信息和退出按钮 -->
            <div v-if="currentUserInfo" class="flex items-center gap-2 mr-2">
              <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-sm font-medium text-gray-700 overflow-hidden relative">
                <img 
                  :src="`/api/user/avatar/${currentUserInfo.ant_uid}`" 
                  alt="用户头像" 
                  class="w-full h-full object-cover"
                  @error="onAvatarError"
                  ref="avatarImage"
                >
              </div>
              <span class="text-sm text-gray-700">{{ currentUserInfo.Name || `用户${currentUserInfo.ant_uid}` }}</span>
              <button 
                class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm transition-colors"
                @click="handleLogout"
                title="退出登录"
              >
                退出
              </button>
            </div>
          </div>
        </div>
        <!-- 语言选择卡片 -->
        <div class="mt-4 p-3 bg-gray-50 rounded-lg">
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-600">*语言/Language</span>
            <select 
              v-model="language" 
              @change="changeLanguage"
              class="ml-auto px-3 py-1.5 border border-gray-300 rounded-md bg-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50"
            >
              <option value="zh">中文</option>
              <option value="en">English</option>
            </select>
          </div>
        </div>
      </div>

      <div class="flex-1 overflow-y-auto p-4 space-y-3" ref="chatMessagesContainer">
        <!-- 欢迎消息 -->
        <div class="flex gap-3" v-if="currentChat.messages.length === 0">
          <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center flex-shrink-0">
            <span class="text-white font-bold text-sm">HEC</span>
          </div>
          <div class="flex-1">
            <div class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm">
              <div class="flex items-center gap-2 mb-3">
                <span class="text-xs text-gray-500">{{ formatTime(new Date()) }}</span>
              </div>
              <p class="leading-relaxed text-gray-800 mb-4">
                {{ language === 'zh' 
                  ? '您好,我是基于集团本地部署 DeepSeek-R1 的药物制剂垂直大模型。此应用适用于药剂学通用知识与前沿研究问答。以下提问模板供参考:' 
                  : 'Hello, I am a pharmaceutical formulation vertical large model based on the group\'s local deployment of DeepSeek-R1. This application is suitable for general knowledge and cutting-edge research questions in pharmaceutics. The following question templates are provided for reference:' 
                }}
              </p>
              <!-- 示例问题 -->
              <div class="space-y-3">
                <div>
                  <h4 class="text-sm font-semibold mb-2 text-gray-800">{{ language === 'zh' ? '单轮对话:' : 'Single-turn dialogue:' }}</h4>
                  <ul class="space-y-1.5">
                    <li v-for="(q, idx) in exampleQuestions.singleTurn[language]" :key="idx" 
                        class="bg-gray-50 rounded-lg text-sm text-gray-700 cursor-pointer border border-gray-200 hover:bg-gray-100 hover:border-gray-300 transition-all" 
                        @click="sendExampleQuestion(q)">
                      {{ q }}
                    </li>
                  </ul>
                </div>
                <div>
                  <h4 class="text-sm font-semibold mb-2 text-gray-800">{{ language === 'zh' ? '多轮对话:' : 'Multi-turn dialogue:' }}</h4>
                  <div class="space-y-2.5">
                    <div v-for="(section, sectionIdx) in exampleQuestions.multiTurn[language]" :key="sectionIdx">
                      <div class="text-xs font-medium text-gray-600 mb-1.5">{{ sectionIdx + 1 }}. {{ section.title }}</div>
                      <ul class="space-y-1.5">
                        <li v-for="(q, idx) in section.questions" :key="idx" 
                            class="p-3 bg-gray-50 rounded-lg text-sm text-gray-700 cursor-pointer border border-gray-200 hover:bg-gray-100 hover:border-gray-300 transition-all" 
                            @click="sendExampleQuestion(q)">
                          {{ q }}
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 用户和助手的消息 -->
        <template v-for="(message, index) in currentChat.messages" :key="index">
          <div 
            class="flex gap-4" 
            :class="message.role === 'user' ? 'justify-end' : ''"
          >
            <template v-if="message.role === 'assistant'">
              <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center flex-shrink-0">
                <span class="text-white font-bold text-sm">HEC</span>
              </div>
            </template>
            
            <div 
              class="max-w-[80%]"
              :class="message.role === 'user' ? 'order-1' : 'order-2 flex-1'"
            >
              <template v-if="loading && index === currentChat.messages.length - 1">
                <!-- 加载状态 - 思考动画 -->
                <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm message-appear">
                  <div class="thinking-container">
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                    <span class="text-sm text-gray-500 ml-2">{{ language === 'zh' ? '正在思考中...' : 'Thinking...' }}</span>
                  </div>
                </div>
              </template>
              <template v-else>
                <div 
                  class="p-2.5 rounded-xl border shadow-sm group relative"
                  :class="message.role === 'user' 
                    ? 'bg-blue-600 text-white border-blue-600' 
                    : 'bg-white border-gray-200'"
                >
                  <!-- 思考过程手风琴 -->
                  <div v-if="message.thinkingContent" class="mb-1">
                    <div class="bg-gray-50 border border-gray-200 rounded-lg overflow-hidden transition-all">
                      <button 
                        @click="toggleThinking(index)"
                        class="w-full px-2.5 py-1.5 bg-gray-100 hover:bg-gray-200 transition-colors flex items-center justify-between text-left"
                      >
                        <div class="flex items-center gap-2">
                          <svg class="w-3.5 h-3.5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                          </svg>
                          <span class="text-xs font-medium text-gray-600">思考过程</span>
                          <span class="text-[10px] text-gray-400">({{ message.thinkingContent.length }} 字符)</span>
                        </div>
                        <svg 
                          class="w-3.5 h-3.5 text-gray-500 transition-transform"
                          :class="expandedThinking.has(index) ? 'rotate-180' : ''"
                          fill="none" 
                          stroke="currentColor" 
                          viewBox="0 0 24 24"
                        >
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                      </button>
                      <div v-show="expandedThinking.has(index)" class="p-2.5 bg-white transition-all duration-200">
                        <div class="text-xs text-gray-600 whitespace-pre-wrap leading-relaxed font-mono">
                          {{ message.thinkingContent }}
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <p v-html="formatMessage(message.content)" class="whitespace-pre-wrap leading-relaxed text-sm text-gray-800"></p>
                  
                  <!-- 引用部分 - 现代简洁风格 -->
                  <div v-if="message.references && message.references.length > 0" class="mt-2">
                    <div class="flex items-center gap-1.5 mb-1.5">
                      <span class="text-xs text-blue-600 font-medium">📚</span>
                      <span class="text-xs text-gray-500">{{ language === 'zh' ? '参考文献' : 'References' }}</span>
                    </div>
                    <div class="space-y-1.5">
                      <div 
                        v-for="(ref, refIdx) in message.references" 
                        :key="refIdx"
                        class="flex gap-2 text-xs leading-relaxed"
                      >
                        <span class="text-blue-600 font-medium min-w-[18px] mt-0.5">{{ refIdx + 1 }}.</span>
                        <span class="text-gray-600 flex-1" v-html="formatMessage(ref)"></span>
                      </div>
                    </div>
                  </div>
                  
                  <!-- 消息时间戳和操作按钮 -->
                  <div class="flex items-center justify-between mt-2">
                    <div class="text-[10px] text-gray-400" :class="message.role === 'user' ? 'text-white/60' : ''">
                      {{ formatTime(message.timestamp || new Date()) }}
                    </div>
                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                      <button 
                        class="p-1 rounded transition-colors"
                        :class="message.role === 'user' ? 'hover:bg-blue-500' : 'hover:bg-gray-100'"
                        @click="copyMessage(message.content)"
                        title="复制"
                      >
                        <svg class="w-3 h-3 transition-colors" 
                             :class="message.role === 'user' ? 'text-white/80 hover:text-white' : 'text-gray-500'" 
                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                      </button>
                      <button 
                        v-if="message.role === 'assistant'"
                        class="p-1 hover:bg-gray-100 rounded transition-colors"
                        @click="likeMessage(index)"
                        title="点赞"
                      >
                        <svg class="w-3 h-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                        </svg>
                      </button>
                      <button 
                        class="p-1 rounded transition-colors"
                        :class="message.role === 'user' ? 'hover:bg-blue-500' : 'hover:bg-gray-100'"
                        @click="deleteMessage(index)"
                        title="删除消息"
                      >
                        <svg class="w-3 h-3 transition-colors" 
                             :class="message.role === 'user' ? 'text-white/80 hover:text-white' : 'text-gray-500'" 
                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              </template>
            </div>
            
            <template v-if="message.role === 'user'">
              <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-sm text-gray-600 order-0 flex-shrink-0">👤</div>
            </template>
          </div>
        </template>
      </div>

      <!-- 输入区域 -->
      <div class="p-3 border-t border-gray-200 bg-white">
        <div class="flex gap-3 items-center">
          <div class="flex-1 relative">
            <textarea 
              v-model="userInput" 
              @keydown.ctrl.enter="sendMessage"
              @keydown.shift.enter="sendMessage"
              @keydown.escape="clearInput"
              :placeholder="language === 'zh' ? '请输入您的问题...' : 'Please enter your question...'"
              :disabled="loading"
              class="w-full p-3 border border-gray-300 rounded-lg text-sm leading-relaxed resize-none min-h-[44px] max-h-[120px] focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors disabled:bg-gray-50 disabled:cursor-not-allowed"
            ></textarea>
          </div>
          <button 
            v-if="!loading"
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center gap-2 h-[44px]"
            @click="sendMessage"
            :disabled="loading || !userInput.trim()"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
            {{ language === 'zh' ? '发送' : 'Send' }}
          </button>
          <button 
            v-else
            class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2 h-[44px]"
            @click="cancelRequest"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            {{ language === 'zh' ? '终止' : 'Stop' }}
          </button>
        </div>
      </div>
    </div>

    <!-- 登录提示对话框 -->
    <div v-if="showLoginDialog" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-xl p-6 max-w-md w-full mx-4 transform transition-all duration-300 scale-100">
        <div class="text-center mb-6">
          <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
          </div>
          <h3 class="text-xl font-bold text-gray-800">
            {{ language === 'zh' ? '请先登录' : 'Please Login First' }}
          </h3>
          <p class="text-gray-500 mt-2">
            {{ language === 'zh' ? '请输入您的账号密码以登录' : 'Please enter your username and password to log in' }}
          </p>
        </div>
        <div class="flex mb-6 border-b">
          <button 
            class="flex-1 py-2 text-center font-medium transition-colors" 
            :class="loginType === 'user' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'"
            @click="loginType = 'user'"
          >
            {{ language === 'zh' ? '用户登录' : 'User Login' }}
          </button>
          <button 
            class="flex-1 py-2 text-center font-medium transition-colors" 
            :class="loginType === 'sys' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'"
            @click="loginType = 'sys'"
          >
            {{ language === 'zh' ? '系统登录' : 'System Login' }}
          </button>
        </div>
        <div class="space-y-4 mb-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              {{ language === 'zh' ? '用户名' : 'Username' }}
            </label>
            <input 
              v-model="loginUsername" 
              type="text" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-colors"
              :placeholder="language === 'zh' ? '请输入用户名' : 'Please enter username'"
            >
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              {{ language === 'zh' ? '密码' : 'Password' }}
            </label>
            <input 
              v-model="loginPassword" 
              type="password" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-colors"
              :placeholder="language === 'zh' ? '请输入密码' : 'Please enter password'"
            >
          </div>
          <div v-if="loginError" class="text-red-500 text-sm">
            {{ loginError }}
          </div>
        </div>
        <div class="space-y-4">
          <button 
            class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors flex items-center justify-center gap-2"
            @click="handleLogin"
            :disabled="loginLoading"
          >
            <svg v-if="loginLoading" class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            <svg v-else class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3v-1m3 0h10"></path>
            </svg>
            {{ language === 'zh' ? '登录' : 'Login' }}
          </button>
          <button 
            class="w-full py-3 px-4 bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium rounded-lg transition-colors"
            @click="closeLoginDialog"
            :disabled="loginLoading"
          >
            {{ language === 'zh' ? '取消' : 'Cancel' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { ref, reactive, onMounted, nextTick } from 'vue';
import { getCurrentUserInfo, autoLoginCheck, login, logout } from './login.js';

export default {
  name: 'App',
  setup() {
    // 状态管理
    const language = ref('zh');
    const userInput = ref('');
    const loading = ref(false);
    const chatHistory = ref([]);
    const expandedThinking = ref(new Set());
    const currentChat = reactive({
      messages: []
    });
    const chatMessagesContainer = ref(null);
    const currentChatIndex = ref(-1);
    const currentChatTitle = ref('');
    const showLoginDialog = ref(false);
    const loginType = ref('user');
    const loginUsername = ref('');
    const loginPassword = ref('');
    const loginError = ref('');
    const loginLoading = ref(false);
    const currentUserInfo = ref(null);

    // ========== 工具函数 ==========
    const formatMessage = (content) => {
      if (!content || content.trim() === '') return '';
      return content
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code>$1</code>');
    };

    const scrollToBottom = () => {
      if (chatMessagesContainer.value) {
        chatMessagesContainer.value.scrollTop = chatMessagesContainer.value.scrollHeight;
      }
    };

    const updateAssistantMessage = (content, thinking, references) => {
      if (currentChat.messages.length === 0) return;
      const lastIndex = currentChat.messages.length - 1;
      const lastMessage = currentChat.messages[lastIndex];
      if (lastMessage.role === 'assistant') {
        currentChat.messages[lastIndex] = {
          ...lastMessage,
          content,
          thinkingContent: thinking,
          references
        };
        currentChat.messages = [...currentChat.messages];
      }
    };

    // ========== 登录相关 ==========
    const handleLogin = async () => {
      loginError.value = '';
      if (!loginUsername.value.trim()) {
        loginError.value = language.value === 'zh' ? '请输入用户名' : 'Please enter username';
        return;
      }
      if (!loginPassword.value.trim()) {
        loginError.value = language.value === 'zh' ? '请输入密码' : 'Please enter password';
        return;
      }
      loginLoading.value = true;
      try {
        const success = await login(loginUsername.value.trim(), loginPassword.value.trim(), loginType.value);
        if (success) {
          const isLoggedIn = await autoLoginCheck();
          if (isLoggedIn) {
            currentUserInfo.value = await getCurrentUserInfo();
            showLoginDialog.value = false;
            resetLoginForm();
          } else {
            loginError.value = '登录后验证失败，请重试';
          }
        } else {
          loginError.value = '登录请求失败';
        }
      } catch (error) {
        loginError.value = error.message || '登录异常';
      } finally {
        loginLoading.value = false;
      }
    };

    const resetLoginForm = () => {
      loginUsername.value = '';
      loginPassword.value = '';
      loginError.value = '';
      loginType.value = 'user';
    };

    const closeLoginDialog = () => {
      showLoginDialog.value = false;
    };

    // ========== 聊天历史 ==========
    const loadChatHistory = () => {
      const savedHistory = localStorage.getItem('chatHistory');
      if (savedHistory) {
        chatHistory.value = JSON.parse(savedHistory);
      }
    };

    const saveChatHistory = () => {
      const historyToSave = chatHistory.value.map(chat => ({
        question: chat.question,
        timestamp: chat.timestamp || new Date(),
        messages: chat.messages.map(msg => ({
          role: msg.role,
          content: msg.content,
          thinkingContent: msg.thinkingContent || '',
          references: msg.references || [],
          timestamp: msg.timestamp || new Date()
        }))
      }));
      localStorage.setItem('chatHistory', JSON.stringify(historyToSave));
    };

    const startNewChat = () => {
      currentChat.messages = [];
      userInput.value = '';
      currentChatIndex.value = -1;
      currentChatTitle.value = '';
    };

    const loadChat = (index) => {
      const chat = chatHistory.value[index];
      currentChat.messages = chat.messages.map(msg => ({
        ...msg,
        thinkingContent: msg.thinkingContent || ''
      }));
      currentChatIndex.value = index;
      currentChatTitle.value = chat.question;
      expandedThinking.value.clear();
    };

    const deleteChat = (index) => {
      if (confirm(language.value === 'zh' ? '确定要删除这条对话记录吗？' : 'Are you sure you want to delete this conversation?')) {
        chatHistory.value.splice(index, 1);
        saveChatHistory();
      }
    };

    // ========== 消息处理 ==========
    const exampleQuestions = {
      singleTurn: {
        zh: [
          '影响半固体剂型溶出特征的关键因素有哪些？',
          '气体分散型剂型的优势是什么？'
        ],
        en: [
          'What are the key factors affecting the dissolution characteristics of semi-solid dosage forms?',
          'What are the advantages of gas dispersion dosage forms?'
        ]
      },
      multiTurn: {
        zh: [
          {
            title: '固体分散体技术综述',
            questions: [
              '制备固体分散体剂型的主要目的是什么？',
              '采用固体分散体技术可使药物的溶出速率提升多少？',
              '固体分散体中溶解增强的可能机制有哪些？'
            ]
          },
          {
            title: '纳米颗粒案例研究',
            questions: [
              '纳米颗粒在药物递送中的优势是什么？',
              '如何制备稳定的纳米颗粒制剂？'
            ]
          }
        ],
        en: [
          {
            title: 'Review of Solid Dispersion Technology',
            questions: [
              'What is the primary purpose of creating solid dispersion dosage forms?',
              'How much can the dissolution rate of a drug increase when using solid dispersions?',
              'What are the possible mechanisms of enhanced dissolution in solid dispersions?'
            ]
          },
          {
            title: 'Nanoparticle Case Study',
            questions: [
              'What are the advantages of nanoparticles in drug delivery?',
              'How to prepare stable nanoparticle formulations?'
            ]
          }
        ]
      }
    };

    const sendExampleQuestion = (question) => {
      userInput.value = question;
      sendMessage();
    };

    const sendMessage = async () => {
      if (!userInput.value.trim() || loading.value) return;
      if (!currentUserInfo.value) {
        showLoginDialog.value = true;
        return;
      }

      let accumulatedContent = '';
      let accumulatedThinking = '';
      let accumulatedReferences = []; // ✅ 已声明
      let isInThinking = false;
      let hasThinkingStarted = false;

      const question = userInput.value.trim();
      currentChat.messages.push({
        role: 'user',
        content: question,
        timestamp: new Date()
      });
      nextTick(() => scrollToBottom());

      userInput.value = '';
      loading.value = true;

      currentChat.messages.push({
        role: 'assistant',
        content: '',
        thinkingContent: '',
        references: [],
        timestamp: new Date()
      });

      const messages = [
        { role: 'user', content: '这是一个模拟开场白' },
        { role: 'assistant', content: '\n我是一位制剂专家。' },
        { role: 'user', content: question }
      ];

      const apiUrl = '/api/v1/chat/completions';
      const apiKey = 'fastgpt-mKIZmHlk5l9WSEuyMlqfqpEXEb4OzTc0nd5zFJp3DAWX0zxbGddjySq3eC';

      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`,
            'Accept': 'text/event-stream',
            'Cache-Control': 'no-cache'
          },
          body: JSON.stringify({
            stream: true,
            messages,
            model: 'DeepSeek-R1'
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value, { stream: true });
          buffer += chunk;

          let newlineIndex;
          while ((newlineIndex = buffer.indexOf('\n')) !== -1) {
            let line = buffer.slice(0, newlineIndex).trim();
            buffer = buffer.slice(newlineIndex + 1);

            if (line.startsWith('data:')) {
              const dataStr = line.slice(5).trim();
              if (dataStr === '[DONE]') {
                chatHistory.value.push({
                  question,
                  messages: currentChat.messages.map(msg => ({
                    ...msg,
                    content: msg.content,
                    thinkingContent: msg.thinkingContent,
                    references: msg.references || []
                  })),
                  timestamp: new Date()
                });
                if (chatHistory.value.length > 10) chatHistory.value.shift();
                saveChatHistory();
                loading.value = false;
                return;
              }

              try {
                const parsed = JSON.parse(dataStr);
                const delta = parsed.choices?.[0]?.delta || {};
                const content = delta.content || '';
                const reasoning = delta.reasoning_content || '';

                if (reasoning === 'thinks>') {
                  isInThinking = true;
                  accumulatedThinking = '';
                  hasThinkingStarted = true;
                  updateAssistantMessage(accumulatedContent, accumulatedThinking, accumulatedReferences);
                  continue;
                } else if (reasoning === '</think>') {
                  isInThinking = false;
                  updateAssistantMessage(accumulatedContent, accumulatedThinking, accumulatedReferences);
                  continue;
                }

                if (isInThinking && reasoning) {
                  accumulatedThinking += reasoning;
                  updateAssistantMessage(accumulatedContent, accumulatedThinking, accumulatedReferences);
                  nextTick(scrollToBottom);
                  if (loading.value) loading.value = false;
                  continue;
                }

                if (content) {
                  accumulatedContent += content;
                  updateAssistantMessage(accumulatedContent, accumulatedThinking, accumulatedReferences);
                  nextTick(scrollToBottom);
                  if (loading.value) loading.value = false;
                }

                if (delta.references) {
                  accumulatedReferences = delta.references;
                  updateAssistantMessage(accumulatedContent, accumulatedThinking, accumulatedReferences);
                }

              } catch (e) {
                console.error('Parse error:', e, dataStr);
              }
            }
          }
        }
      } catch (error) {
        console.error('发送消息失败:', error);
        loading.value = false;
        const errorMsg = {
          role: 'assistant',
          content: language.value === 'zh'
            ? `网络错误：${error.message || '请检查网络或稍后重试'}`
            : `Network error: ${error.message || 'Please check your connection'}`,
          thinkingContent: '',
          references: [],
          timestamp: new Date()
        };
        currentChat.messages.push(errorMsg);
      } finally {
        loading.value = false;
      }
    };

    const cancelRequest = () => {
      loading.value = false;
      if (currentChat.messages.length > 0 && currentChat.messages[currentChat.messages.length - 1].role === 'assistant') {
        currentChat.messages.pop();
      }
      const cancelMessage = {
        role: 'assistant',
        content: language.value === 'zh' ? '对话终止' : 'Conversation terminated',
        references: [],
        timestamp: new Date()
      };
      currentChat.messages.push(cancelMessage);
    };

    const toggleThinking = (index) => {
      if (expandedThinking.value.has(index)) {
        expandedThinking.value.delete(index);
      } else {
        expandedThinking.value.add(index);
      }
    };

    // ========== 其他功能 ==========
    const clearInput = () => { userInput.value = ''; };
    const copyMessage = async (content) => {
      try { await navigator.clipboard.writeText(content); } catch (err) { console.error('复制失败:', err); }
    };
    const likeMessage = (index) => { console.log('点赞消息:', index); };
    const deleteMessage = (index) => {
      if (confirm('确定要删除这条消息吗？')) {
        currentChat.messages.splice(index, 1);
        saveChatHistory();
      }
    };
    const handleLogout = async () => {
      if (confirm(language.value === 'zh' ? '确定要退出登录吗？' : 'Are you sure you want to log out?')) {
        try {
          const success = await logout(true);
          if (success) {
            currentUserInfo.value = null;
            currentChat.messages = [];
            showLoginDialog.value = true;
          }
        } catch (error) {
          console.error('退出登录错误:', error);
        }
      }
    };
    const onAvatarError = (event) => { event.target.style.opacity = '0'; };
    const loadMoreChats = () => { console.log('加载更多'); };
    const exportChat = () => { /* 保留占位 */ };
    const changeLanguage = () => {};

    const formatTime = (date) => {
      return new Date(date).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    };
    const formatDate = (date) => {
      const d = new Date(date);
      return `${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    };

    // ========== 初始化 ==========
    onMounted(async () => {
      loadChatHistory();
      try {
        const isLoggedIn = await autoLoginCheck();
        if (isLoggedIn) {
          currentUserInfo.value = await getCurrentUserInfo();
        } else {
          showLoginDialog.value = true;
        }
      } catch (error) {
        console.error('[App] 自动登录异常:', error);
        showLoginDialog.value = true;
      }
    });

    return {
      language,
      userInput,
      loading,
      chatHistory,
      currentChat,
      currentChatIndex,
      currentChatTitle,
      exampleQuestions,
      startNewChat,
      loadChat,
      changeLanguage,
      sendExampleQuestion,
      sendMessage,
      formatMessage,
      chatMessagesContainer,
      clearInput,
      deleteChat,
      formatTime,
      formatDate,
      copyMessage,
      likeMessage,
      deleteMessage,
      loadMoreChats,
      cancelRequest,
      showLoginDialog,
      closeLoginDialog,
      onAvatarError,
      loginType,
      loginUsername,
      loginPassword,
      loginError,
      loginLoading,
      handleLogin,
      currentUserInfo,
      handleLogout,
      expandedThinking,
      toggleThinking,
      saveChatHistory,
      exportChat
    };
  }
};
</script>

<style scoped>
.thinking-container {
  display: flex;
  align-items: center;
}
.thinking-dot {
  width: 8px;
  height: 8px;
  background: #94a3b8;
  border-radius: 50%;
  margin-right: 4px;
  animation: thinking 1.4s infinite ease-in-out both;
}
.thinking-dot:nth-child(2) {
  animation-delay: -0.32s;
}
.thinking-dot:nth-child(3) {
  animation-delay: -0.64s;
}
@keyframes thinking {
  0%, 80%, 100% { transform: scale(0); }
  40% { transform: scale(1); }
}
</style>